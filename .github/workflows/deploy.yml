name: æ„å»ºä¸éƒ¨ç½²

on:
  push:
    branches: [main]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    concurrency: production

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # æµ…å…‹éš†ï¼Œæé«˜é€Ÿåº¦

      - name: æœåŠ¡å™¨æ‰§è¡Œéƒ¨ç½²å‘½ä»¤
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
            cd /opt/1panel/apps/openresty/openresty/www/sites/wenjiexusite/LandingPage

            # è®¾ç½®ä»£ç†åŠ é€Ÿ
            git remote set-url origin https://gh.xmly.dev/https://github.com/WayneXuCN/LandingPage
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            git config --global --add safe.directory "$(pwd)"
            git fetch --all --depth=1
            git reset --hard origin/main
            git pull --depth=1

            # è®¾ç½® PATH ç¯å¢ƒå˜é‡ä»¥åŒ…å« bun
            export PATH="/root/.bun/bin:$PATH"
            
            # éªŒè¯ bun æ˜¯å¦å¯ç”¨
            which bun || echo "bun not found in PATH"
            
            # å®‰è£…ä¾èµ–å¹¶æ„å»º
            bun install
            bun run build

            # å°† dist æ–‡ä»¶å¤¹å†…å®¹ç§»åŠ¨åˆ° index ç›®å½•
            rm -rf /opt/1panel/apps/openresty/openresty/www/sites/wenjiexusite/index/*
            cp -r dist/* /opt/1panel/apps/openresty/openresty/www/sites/wenjiexusite/index/

            # è®¾ç½®indexæ–‡ä»¶æƒé™ä¸º PHP-FPM ç”¨æˆ·
            chown -R 1000:1000 /opt/1panel/apps/openresty/openresty/www/sites/wenjiexusite/index

            echo "âœ… æ„å»ºæ–‡ä»¶å·²ç§»åŠ¨åˆ° index ç›®å½•"
            echo "âœ… index ç›®å½•æ–‡ä»¶æƒé™å·²è®¾ç½®ä¸º 1000:1000"
            echo "ğŸš€ éƒ¨ç½²å®Œæˆæ—¶é—´: $(date)"
